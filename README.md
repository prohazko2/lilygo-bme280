# LilyGO TTGO T-Call (SIM800L) + BME280 → MQTT

Пример проекта PlatformIO (Arduino) для платы LilyGO TTGO T-Call ESP32 (с модемом SIM800L), который:
- инициализирует датчик `BME280` по I2C,
- подключается к мобильной сети (GSM/GPRS) через `TinyGSM`,
- публикует показания температуры в `MQTT` брокер через `PubSubClient`,
- делает немедленную публикацию после успешного подключения,
- отправляет данные каждые 5 минут,
- имеет сторожевой таймер: если публикаций не было 10 минут — перезагружает устройство.

## Аппаратные требования
- LilyGO TTGO T-Call ESP32 (SIM800L)
- Датчик `BME280` (адрес 0x76 по умолчанию)
- SIM-карта с активным GPRS
- Надёжное питание (SIM800L требует пиковые токи до ~2А)

## Подключение
- I2C (ESP32 по умолчанию): `SDA = 21`, `SCL = 22`
- Пины модема (в коде):
  - `MODEM_TX = 27`
  - `MODEM_RX = 26`
  - `MODEM_PWRKEY = 4`
  - `MODEM_RST = 5`
  - `MODEM_POWER_ON = 23`

При необходимости скорректируйте пины под вашу ревизию платы.

## Зависимости
Автоматически подтягиваются через `platformio.ini`:
- `Adafruit BME280 Library`
- `Adafruit Unified Sensor`
- `TinyGSM`
- `PubSubClient`

## Настройка
Откройте `src/main.cpp` и укажите параметры сети и брокера:
- APN: `GPRS_APN`, при необходимости `GPRS_USER`, `GPRS_PASS`
- MQTT: `MQTT_HOST`, `MQTT_PORT`, опционально `MQTT_USER`, `MQTT_PASS`, `MQTT_TOPIC`, `MQTT_CLIENT_ID`

Период публикации настраивается константой:
```cpp
const unsigned long publishIntervalMs = 300000; // 5 минут
```

## Сборка и загрузка
1. Установите [PlatformIO](https://platformio.org/).
2. Подключите плату по USB.
3. Соберите и загрузите прошивку для окружения `ttgo-tcall`:
   - через IDE PlatformIO: Project Tasks → `ttgo-tcall` → Upload
   - или CLI: `pio run -e ttgo-tcall -t upload`
4. Откройте сериал монитор на 115200 бод, чтобы видеть логи подключения и публикации.

## Формат сообщения MQTT
Публикация в топик `MQTT_TOPIC` (по умолчанию примерный):
```json
{"c": 23.45}
```
где `c` — температура в °C. При желании легко вернуть влажность и давление (строки в `publishBme()` уже подготовлены и закомментированы).

## Поведение подключения
- При старте: инициализируется I2C и BME280, поднимается модем, выполняется регистрация в сети и GPRS attach.
- При первом успешном подключении к MQTT — немедленная публикация.
- Далее публикации каждые 5 минут.
- Если сеть/GPRS или MQTT отваливаются, идёт автоматическое переподключение.
- Если 10 минут не было успешных публикаций — выполняется `ESP.restart()`.

## Отладка
В сериал мониторе отображаются:
- статус регистрации в сети, оператор, RSSI;
- ход GPRS attach (APN);
- попытки подключения к MQTT и коды состояния `PubSubClient` при ошибке;
- отметки об успешной/неуспешной публикации.

Если подключения к брокеру нет:
- проверьте `MQTT_HOST`/`PORT`, учётные данные;
- убедитесь, что брокер доступен из мобильной сети (некоторые брокеры доступны только из локальной сети);
- проверьте баланс/активацию GPRS у оператора и корректность `APN`.

## Замечания
- В `platformio.ini` используется `board = esp32dev`, так как TTGO T-Call основана на ESP32-модуле. При желании можно выбрать другой `board`, совместимый с вашей ревизией.
- Для TLS (порт 8883) пример не настроен; потребуется `TinyGsmClientSecure` и соответствующая настройка сертификатов.

## Лицензия
Свободно используйте и модифицируйте под свои задачи.